<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kyverno based authz in a mesh"><link href=https://github.io/kyverno/kyverno-envoy-plugin/main/performance/ rel=canonical><link href=../tutorials/mtls-istio/ rel=prev><link rel=icon href=../static/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.42"><title>Performance - Kyverno Envoy plugin</title><link rel=stylesheet href=../assets/stylesheets/main.0253249f.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../static/extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Kyverno Envoy plugin - Performance"><meta property=og:description content="Kyverno based authz in a mesh"><meta content=https://github.io/kyverno/kyverno-envoy-plugin/main/performance/ property=og:url><meta property=og:image content=https://github.io/kyverno/kyverno-envoy-plugin/main/static/card.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@goreleaser><meta name=twitter:creator content=@goreleaser><meta name=twitter:title content="Kyverno Envoy plugin - Performance"><meta name=twitter:description content="Kyverno based authz in a mesh"><meta name=twitter:image content=https://github.io/kyverno/kyverno-envoy-plugin/main/static/card.png></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#performance class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> <aside class="md-banner md-banner--warning"> <div class="md-banner__inner md-grid md-typeset"> You're not viewing the latest version. <a href=../..> <strong>Click here to go to latest.</strong> </a> </div> <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script> </aside> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Kyverno Envoy plugin" class="md-header__button md-logo" aria-label="Kyverno Envoy plugin" data-md-component=logo> <img src=../static/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Kyverno Envoy plugin </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Performance </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=light-blue data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kyverno/kyverno-envoy-plugin title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> kyverno/kyverno-envoy-plugin </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../intro/ class=md-tabs__link> Documentation </a> </li> <li class=md-tabs__item> <a href=../tutorials/standalone-envoy/ class=md-tabs__link> Tutorials </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=./ class=md-tabs__link> Performance </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Kyverno Envoy plugin" class="md-nav__button md-logo" aria-label="Kyverno Envoy plugin" data-md-component=logo> <img src=../static/logo.png alt=logo> </a> Kyverno Envoy plugin </label> <div class=md-nav__source> <a href=https://github.com/kyverno/kyverno-envoy-plugin title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> kyverno/kyverno-envoy-plugin </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Documentation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../intro/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../quick-start/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> Writing policies </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Writing policies </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../policies/policies/ class=md-nav__link> <span class=md-ellipsis> Policy Structure </span> </a> </li> <li class=md-nav__item> <a href=../policies/asserts/ class=md-nav__link> <span class=md-ellipsis> Assertion trees </span> </a> </li> <li class=md-nav__item> <a href=../policies/authz-policy/ class=md-nav__link> <span class=md-ellipsis> Policy Reference </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> JMESPath </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> JMESPath </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../jp/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../jp/functions/ class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../tutorials/standalone-envoy/ class=md-nav__link> <span class=md-ellipsis> Standalone Envoy </span> </a> </li> <li class=md-nav__item> <a href=../tutorials/istio/ class=md-nav__link> <span class=md-ellipsis> Istio </span> </a> </li> <li class=md-nav__item> <a href=../tutorials/mtls-istio/ class=md-nav__link> <span class=md-ellipsis> Istio mTLS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Performance </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Performance </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#benchmark-setup class=md-nav__link> <span class=md-ellipsis> Benchmark Setup </span> </a> <nav class=md-nav aria-label="Benchmark Setup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sample-application class=md-nav__link> <span class=md-ellipsis> Sample Application </span> </a> </li> <li class=md-nav__item> <a href=#envoy class=md-nav__link> <span class=md-ellipsis> Envoy </span> </a> </li> <li class=md-nav__item> <a href=#kyverno-envoy-plugin class=md-nav__link> <span class=md-ellipsis> Kyverno-envoy-plugin </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#benchmark-scenarios class=md-nav__link> <span class=md-ellipsis> Benchmark Scenarios </span> </a> </li> <li class=md-nav__item> <a href=#load-testing-with-k6 class=md-nav__link> <span class=md-ellipsis> Load Testing with k6 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#benchmark-setup class=md-nav__link> <span class=md-ellipsis> Benchmark Setup </span> </a> <nav class=md-nav aria-label="Benchmark Setup"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#sample-application class=md-nav__link> <span class=md-ellipsis> Sample Application </span> </a> </li> <li class=md-nav__item> <a href=#envoy class=md-nav__link> <span class=md-ellipsis> Envoy </span> </a> </li> <li class=md-nav__item> <a href=#kyverno-envoy-plugin class=md-nav__link> <span class=md-ellipsis> Kyverno-envoy-plugin </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#benchmark-scenarios class=md-nav__link> <span class=md-ellipsis> Benchmark Scenarios </span> </a> </li> <li class=md-nav__item> <a href=#load-testing-with-k6 class=md-nav__link> <span class=md-ellipsis> Load Testing with k6 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/kyverno/kyverno-envoy-plugin/edit/main/website/docs/performance.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <h1 id=performance>Performance<a class=headerlink href=#performance title="Permanent link">&para;</a></h1> <p>This page offers guidance and best practices for benchmarking the performance of the kyverno-envoy-plugin, helping users understand the associated overhead. It outlines an example setup for conducting benchmarks, various benchmarking scenarios, and key metrics to capture for assessing the impact of the kyverno-envoy-plugin.</p> <h2 id=benchmark-setup>Benchmark Setup<a class=headerlink href=#benchmark-setup title="Permanent link">&para;</a></h2> <p>The benchmark setup consists of the following components:</p> <h3 id=sample-application>Sample Application<a class=headerlink href=#sample-application title="Permanent link">&para;</a></h3> <p>The first component is a simple Go application that provides information of books in the library books collection and exposes APIs to <code>get</code>, <code>create</code> and <code>delete</code> books collection. Check this out for more information about the <a href=https://github.com/Sanskarzz/kyverno-envoy-demos/tree/main/test-application>Go test application</a> . </p> <h3 id=envoy>Envoy<a class=headerlink href=#envoy title="Permanent link">&para;</a></h3> <p>The second component is the Envoy proxy, which runs alongside the example application. The Envoy configuration defines an external authorization filter <code>envoy.ext_authz</code> for a gRPC authorization server. The config uses Envoy's in-built gRPC client to make external gRPC calls.</p> <div class=highlight><pre><span></span><code>static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 8000
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          &quot;@type&quot;: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          codec_type: auto
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains:
              - &quot;*&quot;
              routes:
              - match:
                  prefix: &quot;/&quot;
                route:
                  cluster: service
          http_filters:
          - name: envoy.ext_authz
            typed_config:
              &quot;@type&quot;: type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
              transport_api_version: V3
              with_request_body:
                max_request_bytes: 8192
                allow_partial_message: true
              failure_mode_allow: false
              grpc_service:
                google_grpc:
                  target_uri: 127.0.0.1:9191
                  stat_prefix: ext_authz
                timeout: 0.5s
          - name: envoy.filters.http.router
            typed_config:
              &quot;@type&quot;: type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
  clusters:
  - name: service
    connect_timeout: 0.25s
    type: strict_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8080
admin:
  access_log_path: &quot;/dev/null&quot;
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 8001
layered_runtime:
  layers:
    - name: static_layer_0
      static_layer:
        envoy:
          resource_limits:
            listener:
              example_listener_name:
                connection_limit: 10000
        overload:
          global_downstream_max_connections: 50000
</code></pre></div> <h3 id=kyverno-envoy-plugin>Kyverno-envoy-plugin<a class=headerlink href=#kyverno-envoy-plugin title="Permanent link">&para;</a></h3> <p>The third component is the <code>kyverno-envoy-plugin</code> itself, which is configured to load and enforce Kyverno policies on incoming requests. </p> <div class=highlight><pre><span></span><code><span class=nt>containers</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kyverno-envoy-plugin</span>
<span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">sanskardevops/plugin:0.0.34</span>
<span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
<span class=w>  </span><span class=nt>ports</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8181</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9000</span>
<span class=w>  </span><span class=nt>volumeMounts</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/policies</span>
<span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">policy-files</span>
<span class=w>  </span><span class=nt>args</span><span class=p>:</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;serve&quot;</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;--policy=/policies/policy.yaml&quot;</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;--address=:9000&quot;</span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;--healthaddress=:8181&quot;</span>
<span class=w>  </span><span class=nt>livenessProbe</span><span class=p>:</span>
<span class=w>    </span><span class=nt>httpGet</span><span class=p>:</span>
<span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class=w>      </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HTTP</span>
<span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8181</span>
<span class=w>    </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>    </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>  </span><span class=nt>readinessProbe</span><span class=p>:</span>
<span class=w>    </span><span class=nt>httpGet</span><span class=p>:</span>
<span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/health</span>
<span class=w>      </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">HTTP</span>
<span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">8181</span>
<span class=w>    </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class=w>    </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class=w>  </span>
</code></pre></div> <h2 id=benchmark-scenarios>Benchmark Scenarios<a class=headerlink href=#benchmark-scenarios title="Permanent link">&para;</a></h2> <p>The following scenarios should be tested to compare the performance of the <code>kyverno-envoy-plugin</code> under different conditions:</p> <ol> <li><strong>App Only</strong>: Requests are sent directly to the application, without Envoy or the <code>kyverno-envoy-plugin</code>.</li> <li><strong>App and Envoy</strong>: Envoy is included in the request path, but the <code>kyverno-envoy-plugin</code> is not (i.e., Envoy External Authorization API is disabled).</li> <li><strong>App, Envoy, and Kyverno (RBAC policy)</strong>: Envoy External Authorization API is enabled, and a sample real-world RBAC policy is loaded into the <code>kyverno-envoy-plugin</code>.</li> </ol> <h2 id=load-testing-with-k6>Load Testing with k6<a class=headerlink href=#load-testing-with-k6 title="Permanent link">&para;</a></h2> <p>To perform load testing, we'll use the k6 tool. Follow these steps:</p> <ol> <li> <p><strong>Install k6</strong>: Install k6 on your machine by following the instructions on the official website: https://k6.io/docs/getting-started/installation/</p> </li> <li> <p><strong>Write the k6 script</strong>: Below is the example k6 script. </p> </li> </ol> <div class=highlight><pre><span></span><code><span class=k>import</span><span class=w> </span><span class=nx>http</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;k6/http&#39;</span><span class=p>;</span>
<span class=k>import</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>check</span><span class=p>,</span><span class=w> </span><span class=nx>group</span><span class=p>,</span><span class=w> </span><span class=nx>sleep</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=kr>from</span><span class=w> </span><span class=s1>&#39;k6&#39;</span><span class=p>;</span>

<span class=k>export</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=nx>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=nx>stages</span><span class=o>:</span><span class=w> </span><span class=p>[</span>
<span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;30s&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=o>:</span><span class=w> </span><span class=mf>100</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=c1>// Ramp-up to 100 virtual users over 30 seconds</span>
<span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;1m&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=o>:</span><span class=w> </span><span class=mf>100</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=c1>// Stay at 100 virtual users for 1 minute</span>
<span class=w>    </span><span class=p>{</span><span class=w> </span><span class=nx>duration</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;30s&#39;</span><span class=p>,</span><span class=w> </span><span class=nx>target</span><span class=o>:</span><span class=w> </span><span class=mf>0</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=c1>// Ramp-down to 0 virtual users over 30 seconds</span>
<span class=w>  </span><span class=p>],</span>
<span class=p>};</span>

<span class=cm>/*</span>
<span class=cm>Replace ip for every scenerio</span>
<span class=cm>export SERVICE_PORT=$(kubectl -n demo get service testapp -o jsonpath=&#39;{.spec.ports[?(@.port==8080)].nodePort}&#39;)</span>
<span class=cm>export SERVICE_HOST=$(minikube ip)</span>
<span class=cm>export SERVICE_URL=$SERVICE_HOST:$SERVICE_PORT</span>
<span class=cm>echo $SERVICE_URL</span>

<span class=cm>http://192.168.49.2:31541</span>

<span class=cm>*/</span>
<span class=kd>const</span><span class=w> </span><span class=nx>BASE_URL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;http://192.168.49.2:31541&#39;</span><span class=p>;</span><span class=w> </span>

<span class=k>export</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=nx>group</span><span class=p>(</span><span class=s1>&#39;GET /book with guest token&#39;</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>BASE_URL</span><span class=si>}</span><span class=sb>/book`</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s1>&#39;Authorization&#39;</span><span class=o>:</span><span class=w> </span><span class=s1>&#39;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjIyNDEwODE1MzksIm5iZiI6MTUxNDg1MTEzOSwicm9sZSI6Imd1ZXN0Iiwic3ViIjoiWVd4cFkyVT0ifQ.ja1bgvIt47393ba_WbSBm35NrUhdxM4mOVQN8iXz8lk&#39;</span><span class=w> </span><span class=p>},</span>
<span class=w>    </span><span class=p>});</span>
<span class=w>    </span><span class=nx>check</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span><span class=w> </span><span class=p>{</span>
<span class=w>      </span><span class=s1>&#39;is status 200&#39;</span><span class=o>:</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=p>)</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>status</span><span class=w> </span><span class=o>===</span><span class=w> </span><span class=mf>200</span><span class=p>,</span>
<span class=w>    </span><span class=p>});</span>
<span class=w>  </span><span class=p>});</span>

<span class=w>  </span><span class=nx>sleep</span><span class=p>(</span><span class=mf>1</span><span class=p>);</span><span class=w> </span><span class=c1>// Sleep for 1 second between iterations</span>
<span class=p>}</span>
</code></pre></div> <ol> <li><strong>Run the k6 test</strong>: Run the load test with the following command:</li> </ol> <p><div class=highlight><pre><span></span><code>$<span class=w> </span>k6<span class=w> </span>run<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>import http from &#39;k6/http&#39;;</span>
<span class=s>import { check, group, sleep } from &#39;k6&#39;;</span>

<span class=s>export const options = {</span>
<span class=s>  stages: [</span>
<span class=s>    { duration: &#39;30s&#39;, target: 100 }, // Ramp-up to 100 virtual users over 30 seconds</span>
<span class=s>    { duration: &#39;1m&#39;, target: 100 }, // Stay at 100 virtual users for 1 minute</span>
<span class=s>    { duration: &#39;30s&#39;, target: 0 }, // Ramp-down to 0 virtual users over 30 seconds</span>
<span class=s>  ],</span>
<span class=s>};</span>


<span class=s>const BASE_URL = &#39;http://192.168.49.2:31700&#39;; // Replace with your application URL </span>

<span class=s>export default function () {</span>
<span class=s>  group(&#39;GET /book with guest token&#39;, () =&gt; {</span>
<span class=s>    const res = http.get(`${BASE_URL}/book`, {</span>
<span class=s>      headers: { &#39;Authorization&#39;: &#39;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjIyNDEwODE1MzksIm5iZiI6MTUxNDg1MTEzOSwicm9sZSI6Imd1ZXN0Iiwic3ViIjoiWVd4cFkyVT0ifQ.ja1bgvIt47393ba_WbSBm35NrUhdxM4mOVQN8iXz8lk&#39; },</span>
<span class=s>    });</span>
<span class=s>    check(res, {</span>
<span class=s>      &#39;is status 200&#39;: (r) =&gt; r.status === 200,</span>
<span class=s>    });</span>
<span class=s>  });</span>

<span class=s>  sleep(1); // Sleep for 1 second between iterations</span>
<span class=s>}</span>
<span class=s>EOF</span>
</code></pre></div> 4. <strong>Analyze the results</strong>: Generate an json report with detailed insight by running:</p> <p><div class=highlight><pre><span></span><code><span class=go>k6 run --out json=report.json k6-script.js</span>
</code></pre></div> 5. <strong>*Repeat for different scenarios</strong>: </p> <ul> <li> <h1 id=app-only>App only<a class=headerlink href=#app-only title="Permanent link">&para;</a></h1> <p>In this case , request are sent directly to the sample application ie no Envoy and Kyverno-plugin in the request path . For this run this command to apply the sample applicaition and then test with k6</p> <p><div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/kyverno/kyverno-envoy-plugin/main/tests/performance-test/manifest/app.yaml
</code></pre></div> Results of the k6 when only application is applied ```bash</p> <div class=codehilite><pre><span></span><code>  /\      |‾‾| /‾‾/   /‾‾/
</code></pre></div> <p>/\ / \ | |/ / / / <br> / \/ \ | ( / ‾‾\<br> / \ | |\ \ | (‾) | / <strong><em>_</em></strong><strong><em> \ |</em><em>| _</em>\ _</strong>__/ .io</p> <p>execution: local script: k6-script.js output: -</p> <p>scenarios: (100.00%) 1 scenario, 100 max VUs, 2m30s max duration (incl. graceful stop): * default: Up to 100 looping VUs for 2m0s over 3 stages (gracefulRampDown: 30s, gracefulStop: 30s)</p> <p>█ GET /book with guest token</p> <p>✓ is status 200</p> <p>checks.........................: 100.00% ✓ 9048 ✗ 0 <br> data_received..................: 2.1 MB 18 kB/s data_sent......................: 2.6 MB 21 kB/s group_duration.................: avg=1.01ms min=166.46µs med=775.01µs max=36ms p(90)=1.72ms p(95)=2.31ms<br> http_req_blocked...............: avg=15.08µs min=1.55µs med=6.54µs max=4.09ms p(90)=12.07µs p(95)=15.25µs http_req_connecting............: avg=4.58µs min=0s med=0s max=1.57ms p(90)=0s p(95)=0s <br> http_req_duration..............: avg=745.73µs min=103.06µs med=549.17µs max=35.88ms p(90)=1.26ms p(95)=1.75ms<br> { expected_response:true }...: avg=745.73µs min=103.06µs med=549.17µs max=35.88ms p(90)=1.26ms p(95)=1.75ms<br> http_req_failed................: 0.00% ✓ 0 ✗ 9048 http_req_receiving.............: avg=119.69µs min=11.33µs med=77.78µs max=10.97ms p(90)=193.73µs p(95)=285.58µs http_req_sending...............: avg=41µs min=6.96µs med=31.12µs max=2.39ms p(90)=61.88µs p(95)=78.15µs http_req_tls_handshaking.......: avg=0s min=0s med=0s max=0s p(90)=0s p(95)=0s <br> http_req_waiting...............: avg=585.04µs min=75.52µs med=407.87µs max=35.84ms p(90)=965.49µs p(95)=1.33ms<br> http_reqs......................: 9048 75.050438/s iteration_duration.............: avg=1s min=1s med=1s max=1.06s p(90)=1s p(95)=1s <br> iterations.....................: 9048 75.050438/s vus............................: 2 min=2 max=100 vus_max........................: 100 min=100 max=100</p> </li> </ul> <p>running (2m00.6s), 000/100 VUs, 9048 complete and 0 interrupted iterations default ✓ [======================================] 000/100 VUs 2m0s ``` </p> <ul> <li> <h1 id=app-and-envoy>App and Envoy<a class=headerlink href=#app-and-envoy title="Permanent link">&para;</a></h1> <p>In this case, Kyverno-envoy-plugin is not included in the path but Envoy is but Envoy External Authorization API disabled For this run this command to apply the sample application with envoy.</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/kyverno/kyverno-envoy-plugin/main/tests/performance-test/manifest/app-envoy.yaml
</code></pre></div> <p>Results of k6 after applying sample-application with envoy. ```bash</p> <div class=codehilite><pre><span></span><code>  /\      |‾‾| /‾‾/   /‾‾/
</code></pre></div> <p>/\ / \ | |/ / / / <br> / \/ \ | ( / ‾‾\<br> / \ | |\ \ | (‾) | / <strong><em>_</em></strong><strong><em> \ |</em><em>| _</em>\ _</strong>__/ .io</p> <p>execution: local script: k6-script.js output: -</p> <p>scenarios: (100.00%) 1 scenario, 100 max VUs, 2m30s max duration (incl. graceful stop): * default: Up to 100 looping VUs for 2m0s over 3 stages (gracefulRampDown: 30s, gracefulStop: 30s)</p> <p>█ GET /book with guest token</p> <p>✓ is status 200</p> <p>checks.........................: 100.00% ✓ 9031 ✗ 0 <br> data_received..................: 2.5 MB 21 kB/s data_sent......................: 2.6 MB 21 kB/s group_duration.................: avg=2.66ms min=457.22µs med=1.8ms max=65.53ms p(90)=4.85ms p(95)=6.58ms<br> http_req_blocked...............: avg=12.81µs min=1.52µs med=5.98µs max=2.41ms p(90)=11.84µs p(95)=13.9µs<br> http_req_connecting............: avg=3.82µs min=0s med=0s max=2.34ms p(90)=0s p(95)=0s <br> http_req_duration..............: avg=2.38ms min=383.7µs med=1.58ms max=65.22ms p(90)=4.36ms p(95)=5.92ms<br> { expected_response:true }...: avg=2.38ms min=383.7µs med=1.58ms max=65.22ms p(90)=4.36ms p(95)=5.92ms<br> http_req_failed................: 0.00% ✓ 0 ✗ 9031 http_req_receiving.............: avg=136.3µs min=12.53µs med=76.74µs max=12.75ms p(90)=183.23µs p(95)=272.91µs http_req_sending...............: avg=41.54µs min=6.58µs med=28.1µs max=4.15ms p(90)=59.62µs p(95)=74.85µs http_req_tls_handshaking.......: avg=0s min=0s med=0s max=0s p(90)=0s p(95)=0s <br> http_req_waiting...............: avg=2.2ms min=349.23µs med=1.43ms max=65.08ms p(90)=4.05ms p(95)=5.52ms<br> http_reqs......................: 9031 74.825497/s iteration_duration.............: avg=1s min=1s med=1s max=1.06s p(90)=1s p(95)=1s <br> iterations.....................: 9031 74.825497/s vus............................: 3 min=3 max=100 vus_max........................: 100 min=100 max=100</p> </li> </ul> <p>running (2m00.7s), 000/100 VUs, 9031 complete and 0 interrupted iterations default ✓ [======================================] 000/100 VUs 2m0s ```</p> <ul> <li> <h1 id=app-envoy-and-kyverno-envoy-plugin>App, Envoy and Kyverno-envoy-plugin<a class=headerlink href=#app-envoy-and-kyverno-envoy-plugin title="Permanent link">&para;</a></h1> <p>In this case, performance measurements are observed with Envoy External Authorization API enabled and a sample real-world RBAC policy loaded into kyverno-envoy-plugin . For this apply this command to apply sample-application, envoy and kyverno-envoy-plugin</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>https://raw.githubusercontent.com/kyverno/kyverno-envoy-plugin/main/tests/performance-test/manifest/app-envoy-plugin.yaml
</code></pre></div> <p>Results of k6 after applying sample-application, Envoy and kyverno-envoy-plugin . ```console</p> <div class=codehilite><pre><span></span><code>  /\      |‾‾| /‾‾/   /‾‾/
</code></pre></div> <p>/\ / \ | |/ / / / <br> / \/ \ | ( / ‾‾\<br> / \ | |\ \ | (‾) | / <strong><em>_</em></strong><strong><em> \ |</em><em>| _</em>\ _</strong>__/ .io</p> <p>execution: local script: k6-script.js output: -</p> <p>scenarios: (100.00%) 1 scenario, 100 max VUs, 2m30s max duration (incl. graceful stop): * default: Up to 100 looping VUs for 2m0s over 3 stages (gracefulRampDown: 30s, gracefulStop: 30s)</p> <p>█ GET /book with guest token</p> <p>✓ is status 200</p> <p>checks.........................: 100.00% ✓ 8655 ✗ 0 <br> data_received..................: 2.4 MB 20 kB/s data_sent......................: 2.4 MB 20 kB/s group_duration.................: avg=46.54ms min=4.59ms med=29.69ms max=337.79ms p(90)=109.35ms p(95)=140.51ms http_req_blocked...............: avg=11.88µs min=1.21µs med=4.15µs max=2.83ms p(90)=9.87µs p(95)=11.4µs<br> http_req_connecting............: avg=4.98µs min=0s med=0s max=2.18ms p(90)=0s p(95)=0s <br> http_req_duration..............: avg=46.37ms min=4.49ms med=29.49ms max=337.69ms p(90)=109.26ms p(95)=140.28ms { expected_response:true }...: avg=46.37ms min=4.49ms med=29.49ms max=337.69ms p(90)=109.26ms p(95)=140.28ms http_req_failed................: 0.00% ✓ 0 ✗ 8655 http_req_receiving.............: avg=65.19µs min=11.14µs med=56.47µs max=5.58ms p(90)=102.86µs p(95)=145.19µs http_req_sending...............: avg=30.35µs min=5.43µs med=18.48µs max=5.29ms p(90)=46.63µs p(95)=58µs <br> http_req_tls_handshaking.......: avg=0s min=0s med=0s max=0s p(90)=0s p(95)=0s <br> http_req_waiting...............: avg=46.27ms min=4.43ms med=29.42ms max=337.65ms p(90)=109.22ms p(95)=140.24ms http_reqs......................: 8655 71.999297/s iteration_duration.............: avg=1.04s min=1s med=1.03s max=1.33s p(90)=1.11s p(95)=1.14s <br> iterations.....................: 8655 71.999297/s vus............................: 2 min=2 max=100 vus_max........................: 100 min=100 max=100</p> </li> </ul> <p>running (2m00.2s), 000/100 VUs, 8655 complete and 0 interrupted iterations default ✓ [======================================] 000/100 VUs 2m0s ```</p> <h2 id=measuring-performance>Measuring Performance<a class=headerlink href=#measuring-performance title="Permanent link">&para;</a></h2> <p>The following metrics should be measured to evaluate the performance impact of the <code>kyverno-envoy-plugin</code>:</p> <ul> <li> <p><strong>End-to-end latency</strong> The end-to-end latency represents the time taken for a request to complete, from the client sending the request to receiving the response. Based on the k6 results, the average end-to-end latency for the different scenarios is as follows:</p> </li> <li> <p>App Only: <code>avg=1.01ms</code> (from <code>group_duration</code> or <code>http_req_duration</code>)</p> </li> <li>App and Envoy: <code>avg=2.38ms</code> (from <code>http_req_duration</code>)</li> <li> <p>App, Envoy, and Kyverno-envoy-plugin: <code>avg=46.37ms</code> (from <code>http_req_duration</code>)</p> </li> <li> <p><strong>Kyverno evaluation latency</strong> The Kyverno evaluation latency represents the time taken by the kyverno-envoy-plugin to evaluate the request against the configured policies. While the k6 results do not directly provide this metric, an estimate can be inferred by analyzing the differences in latency between the "App and Envoy" scenario and the "App, Envoy, and Kyverno-envoy-plugin" scenario.</p> </li> </ul> <p>The difference in average latency between these two scenarios is: <code>46.37ms</code> - <code>2.38ms</code> = <code>43.99ms</code></p> <p>This difference can be attributed to the Kyverno evaluation latency and the gRPC server handler latency combined. Assuming the gRPC server handler latency is relatively small compared to the Kyverno evaluation latency, the estimated range for the Kyverno evaluation latency is around 40ms to 45ms.</p> <ul> <li><strong>Resource utilization</strong> Refers to CPU and memory usage of the Kyverno-Envoy-Plugin container , <code>kubectl top</code> utility can be laveraged to measure the resource utilization.</li> </ul> <p>Get the resource utilization of the kyverno-envoy-plugin container using the following command:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>kubectl<span class=w> </span>top<span class=w> </span>pod<span class=w> </span>-n<span class=w> </span>demo<span class=w> </span>--containers
</code></pre></div> <p>To monitor resource utilization overtime use the following command:</p> <div class=highlight><pre><span></span><code>$<span class=w> </span>watch<span class=w> </span>-n<span class=w> </span><span class=m>1</span><span class=w> </span><span class=s2>&quot;kubectl top pod -n demo --containers&quot;</span>
</code></pre></div> <p>Now run the k6 script in different terminal window and observe the resource utilization of the kyverno-envoy-plugin container.</p> <p>Initial resource utilization of the kyverno-envoy-plugin container:</p> <div class=highlight><pre><span></span><code><span class=go>POD                        NAME                   CPU(cores)   MEMORY(bytes)</span>
<span class=go>testapp-5955cd6f8b-dbvgd   envoy                  4m           70Mi</span>
<span class=go>testapp-5955cd6f8b-dbvgd   kyverno-envoy-plugin   1m           51Mi</span>
<span class=go>testapp-5955cd6f8b-dbvgd   test-application       1m           11Mi</span>
</code></pre></div> <p>Resource utilization of the kyverno-envoy-plugin container after 100 requests:</p> <div class=highlight><pre><span></span><code><span class=go>POD                        NAME                   CPU(cores)   MEMORY(bytes)</span>
<span class=go>testapp-5955cd6f8b-dbvgd   envoy                  110m         70Mi</span>
<span class=go>testapp-5955cd6f8b-dbvgd   kyverno-envoy-plugin   895m         60Mi</span>
<span class=go>testapp-5955cd6f8b-dbvgd   test-application       17m          15Mi</span>
</code></pre></div> <p>Observations:</p> <ul> <li>The CPU utilization of the kyverno-envoy-plugin container increased significantly from 1m to 895m after receiving 100 requests during the load test.</li> <li>The memory utilization also increased, but to a lesser extent, from 51Mi to 60Mi.</li> </ul> <p>Resource utilization of the kyverno-envoy-plugin container after load completion:</p> <div class=highlight><pre><span></span><code><span class=go>POD                        NAME                   CPU(cores)   MEMORY(bytes)</span>
<span class=go>testapp-5955cd6f8b-dbvgd   envoy                  4m           70Mi</span>
<span class=go>testapp-5955cd6f8b-dbvgd   kyverno-envoy-plugin   1m           51Mi</span>
<span class=go>testapp-5955cd6f8b-dbvgd   test-application       1m           11Mi</span>
</code></pre></div> <p>Observations: - After the load test completed and the request volume returned to normal levels, the CPU and memory utilization of the kyverno-envoy-plugin container returned to their initial values. This indicates that the kyverno-envoy-plugin can efficiently handle the increased load during the test and release the additional resources when the load subsides.</p> <p>Correlation with k6 results: - The k6 script simulated a load test scenario with 100 virtual users, ramping up over 30 seconds, staying at 100 users for 1 minute, and then ramping down over 30 seconds. - During the load test, when the request volume was at its peak (100 virtual users), the kyverno-envoy-plugin container experienced a significant increase in CPU utilization, reaching 895m. - This CPU utilization spike aligns with the increased processing demand on the kyverno-envoy-plugin to evaluate the incoming requests against the configured Kyverno policies. - The memory utilization increase during the load test was relatively modest, suggesting that the policy evaluation did not significantly impact the memory requirements of the kyverno-envoy-plugin.</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../tutorials/mtls-istio/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Istio mTLS"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Istio mTLS </div> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Made with ❤️ by Kyverno contributors. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["announce.dismiss", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.action.edit", "navigation.footer", "navigation.instant", "navigation.tracking", "navigation.tabs"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../assets/javascripts/bundle.83f73b43.min.js></script> </body> </html>